name: 🚀 Deploy to Production

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  deploy-docker:
    name: 🐳 Docker Hub Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🐳 Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: 🔑 Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: 🏷️ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_USERNAME }}/vertexops
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: 🔨 Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy-pages:
    name: 📄 GitHub Pages Deploy
    runs-on: ubuntu-latest
    # Disabled by patch: Pages deploy caused workflow failures when screenshots/doc assets were missing
    if: 'false'
    permissions:
      contents: read
      pages: write
      id-token: write
      
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4
      
    - name: 📝 Generate deployment page
      run: |
        mkdir -p docs
        cat > docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>VertexOps - LLMOps Platform</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh; display: flex; align-items: center; justify-content: center;
                }
                .container { 
                    max-width: 800px; padding: 2rem; text-align: center; color: white;
                    background: rgba(255,255,255,0.1); border-radius: 20px; backdrop-filter: blur(10px);
                    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
                }
                h1 { font-size: 3rem; margin-bottom: 1rem; }
                .subtitle { font-size: 1.2rem; opacity: 0.9; margin-bottom: 2rem; }
                .buttons { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
                .btn { 
                    padding: 12px 24px; border-radius: 50px; text-decoration: none; font-weight: bold;
                    background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);
                    transition: all 0.3s ease;
                }
                .btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
                .features { margin-top: 3rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
                .feature { 
                    padding: 1.5rem; background: rgba(255,255,255,0.1); border-radius: 10px;
                    border: 1px solid rgba(255,255,255,0.2);
                }
                .feature h3 { margin-bottom: 0.5rem; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>🚀 VertexOps</h1>
                <div class="subtitle">Production-Ready LLMOps Platform</div>
                
                <div class="buttons">
                    <a href="https://github.com/vijaykalore/vertexops" class="btn">📁 GitHub Repository</a>
                    <a href="https://github.com/vijaykalore/vertexops/blob/main/DEPLOYMENT_GUIDE.md" class="btn">📖 Deploy Guide</a>
                    <a href="https://hub.docker.com/r/yourusername/vertexops" class="btn">🐳 Docker Hub</a>
                </div>
                
                <div class="features">
                    <div class="feature">
                        <h3>🤖 Model Operations</h3>
                        <p>Deploy and fine-tune ML models with async processing</p>
                    </div>
                    <div class="feature">
                        <h3>🔍 RAG System</h3>
                        <p>Intelligent query processing with context retrieval</p>
                    </div>
                    <div class="feature">
                        <h3>📊 Vector Search</h3>
                        <p>High-performance similarity search and embeddings</p>
                    </div>
                    <div class="feature">
                        <h3>🌐 Professional UI</h3>
                        <p>Modern web interface with real-time monitoring</p>
                    </div>
                    <div class="feature">
                        <h3>🔒 Enterprise Security</h3>
                        <p>API key authentication and security scanning</p>
                    </div>
                    <div class="feature">
                        <h3>📈 Production Ready</h3>
                        <p>Docker, CI/CD, monitoring, and health checks</p>
                    </div>
                </div>
            </div>
        </body>
        </html>
        EOF
        
    - name: 📄 Setup Pages
      uses: actions/configure-pages@v4
      
    - name: ⬆️ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs
        
    - name: 🚀 Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  notify-success:
    name: 🎉 Deployment Success
    runs-on: ubuntu-latest
    needs: [deploy-docker, deploy-pages]
    if: success()
    
    steps:
    - name: 🎉 Success notification
      run: |
        echo "🎉 VertexOps deployed successfully!"
        echo "🐳 Docker: Available on Docker Hub"
        echo "📄 Docs: Available on GitHub Pages"
        echo "🚀 Ready for production use!"
